{% extends 'base.html' %}
{% load static %}
{% block title %}Smart Device Manager - Devices{% endblock %}

{% block page_title %}Device Management{% endblock %}

{% block page_subtitle %}Monitor and control all your connected smart devices{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/device.css' %}">
<link rel="stylesheet" href="{% static 'css/modal.css' %}">
{% endblock %}

{% block header_stats %}
<div class="grid grid-cols-2 md:grid-cols-5 gap-4 animate-fade-in">
    <div class="glass p-4 rounded-xl border border-white/20 dark:border-gray-700/50">
        <div class="flex items-center space-x-3">
            <div class="p-3 rounded-lg bg-blue-500/10 text-blue-500">
                <i class="fas fa-microchip text-xl"></i>
            </div>
            <div>
                <h3 class="text-sm font-medium text-gray-500 dark:text-gray-400">Total Devices</h3>
                <p id="totalCount" class="text-2xl font-semibold text-gray-900 dark:text-white">{{ total_devices }}</p>
            </div>
        </div>
    </div>

    <div class="glass p-4 rounded-xl border border-white/20 dark:border-gray-700/50">
        <div class="flex items-center space-x-3">
            <div class="p-3 rounded-lg bg-green-500/10 text-green-500">
                <i class="fas fa-check-circle text-xl"></i>
            </div>
            <div>
                <h3 class="text-sm font-medium text-gray-500 dark:text-gray-400">Active Devices</h3>
                <p id="activeCount" class="text-2xl font-semibold text-green-600 dark:text-green-400">{{ active_devices }}</p>
            </div>
        </div>
    </div>

    <div class="glass p-4 rounded-xl border border-white/20 dark:border-gray-700/50">
        <div class="flex items-center space-x-3">
            <div class="p-3 rounded-lg bg-red-500/10 text-red-500">
                <i class="fas fa-times-circle text-xl"></i>
            </div>
            <div>
                <h3 class="text-sm font-medium text-gray-500 dark:text-gray-400">Inactive Devices</h3>
                <p id="inactiveCount" class="text-2xl font-semibold text-red-600 dark:text-red-400">{{ inactive_devices }}</p>
            </div>
        </div>
    </div>

    <div class="glass p-4 rounded-xl border border-white/20 dark:border-gray-700/50">
        <div class="flex items-center space-x-3">
            <div class="p-3 rounded-lg bg-indigo-500/10 text-indigo-500">
                <i class="fas fa-home text-xl"></i>
            </div>
            <div>
                <h3 class="text-sm font-medium text-gray-500 dark:text-gray-400">Total Rooms</h3>
                <p id="totalRooms" class="text-2xl font-semibold text-indigo-600 dark:text-indigo-400">{{ total_rooms }}</p>
            </div>
        </div>
    </div>

    <div class="glass p-4 rounded-xl border border-white/20 dark:border-gray-700/50">
        <div class="flex items-center space-x-3">
            <div class="p-3 rounded-lg bg-purple-500/10 text-purple-500">
                <i class="fas fa-door-open text-xl"></i>
            </div>
            <div>
                <h3 class="text-sm font-medium text-gray-500 dark:text-gray-400">Active Rooms</h3>
                <p id="activeRooms" class="text-2xl font-semibold text-purple-600 dark:text-purple-400">{{ active_rooms }}</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block header_actions %}
<div class="flex items-center space-x-4">
    <div class="relative">
        <input type="text" id="deviceSearch" placeholder="Search devices..."
               class="w-64 pl-10 pr-4 py-2 bg-white/10 dark:bg-black/10 border border-white/20 dark:border-gray-700/50 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent backdrop-blur-sm text-gray-900 dark:text-white">
        <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
    </div>

    <div class="flex items-center bg-white/10 dark:bg-black/10 backdrop-blur-sm rounded-lg p-1 border border-white/20 dark:border-gray-700/50">
        <button id="gridViewBtn" class="view-toggle active px-3 py-2 rounded-md transition-all duration-200" data-view="grid" title="Grid View">
            <i class="fas fa-th"></i>
        </button>
        <button id="tableViewBtn" class="view-toggle px-3 py-2 rounded-md transition-all duration-200" data-view="table" title="Table View">
            <i class="fas fa-list"></i>
        </button>
    </div>

    <button id="addDeviceBtn"
        class="px-6 py-3 rounded-xl text-white font-semibold flex items-center space-x-2 transition-all duration-200
        {% if user.is_superuser %}
            btn-primary hover:shadow-lg transform hover:scale-105 bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-700 hover:to-purple-700
        {% else %}
            bg-gray-400 cursor-not-allowed opacity-70
        {% endif %}"
        {% if not user.is_superuser %}disabled{% endif %}>
    <i class="fas fa-plus"></i>
    <span>Add Device</span>
</button>
</div>
{% endblock %}

{% block content %}
<div id="modalBackdrop" class="fixed inset-0 bg-black/60 dark:bg-black/80 backdrop-blur-sm z-40 opacity-0 invisible transition-all duration-300"></div>

<div id="addDeviceModal" class="fixed inset-0 z-50 flex items-center justify-center p-4 opacity-0 invisible transition-all duration-300">
    <div class="modal-content bg-white/95 dark:bg-gray-900/95 backdrop-blur-lg rounded-2xl border border-white/20 dark:border-gray-700/50 shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto transform scale-95 transition-all duration-300">
        <div class="sticky top-0 bg-gradient-to-r from-blue-600/10 to-purple-600/10 dark:from-blue-500/10 dark:to-purple-500/10 p-6 border-b border-white/20 dark:border-gray-700/50 backdrop-blur-sm">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <div class="w-12 h-12 bg-gradient-to-br from-blue-600 to-purple-600 rounded-xl flex items-center justify-center">
                        <i class="fas fa-plus text-white text-lg"></i>
                    </div>
                    <div>
                        <h3 class="text-2xl font-bold text-gray-900 dark:text-white">Add New Device</h3>
                        <p class="text-sm text-gray-600 dark:text-gray-400">Connect a new smart device to your home</p>
                    </div>
                </div>
                <button id="closeModalBtn" class="p-3 hover:bg-white/20 dark:hover:bg-black/20 rounded-xl transition-all duration-200 text-gray-500 hover:text-gray-700 dark:hover:text-gray-300">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
        </div>

        <div class="p-8">
            <form method="post" action="{% url 'device_new' %}" class="space-y-6" id="deviceForm">
                {% csrf_token %}

                <div class="form-group">
                    <label for="{{ form.name.id_for_label }}" class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-3">
                        <div class="flex items-center space-x-2">
                            <i class="fas fa-tag text-blue-500"></i>
                            <span>Device Name</span>
                            <span class="text-red-500">*</span>
                        </div>
                    </label>
                    <div class="relative">
                        <input type="text" id="{{ form.name.id_for_label }}" name="{{ form.name.name }}"
                               class="form-input w-full px-4 py-4 bg-white/70 dark:bg-black/30 border-2 border-gray-200/50 dark:border-gray-600/50 rounded-xl focus:outline-none focus:ring-4 focus:ring-blue-500/20 focus:border-blue-500 dark:focus:border-blue-400 backdrop-blur-sm transition-all duration-200 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400"
                               placeholder="Enter a descriptive name for your device" value="{{ form.name.value|default:'' }}" required>
                        <div class="absolute inset-y-0 right-0 flex items-center pr-4">
                            <i class="fas fa-microchip text-gray-400"></i>
                        </div>
                    </div>
                    {% if form.name.errors %} {# Check for specific field errors #}
                        {% for error in form.name.errors %}
                        <p class="error-message text-red-500 text-sm mt-2 flex items-center bg-red-50 dark:bg-red-900/20 p-2 rounded-lg">
                            <i class="fas fa-exclamation-circle mr-2"></i>{{ error }}
                        </p>
                        {% endfor %}
                    {% endif %}
                </div>

                <div class="form-group">
                    <label for="{{ form.location.id_for_label }}" class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-3">
                        <div class="flex items-center space-x-2">
                            <i class="fas fa-map-marker-alt text-green-500"></i>
                            <span>Location</span>
                            <span class="text-red-500">*</span>
                        </div>
                    </label>
                    <div class="relative">
                        <input type="text" id="{{ form.location.id_for_label }}" name="{{ form.location.name }}"
                               class="form-input w-full px-4 py-4 bg-white/70 dark:bg-black/30 border-2 border-gray-200/50 dark:border-gray-600/50 rounded-xl focus:outline-none focus:ring-4 focus:ring-green-500/20 focus:border-green-500 dark:focus:border-green-400 backdrop-blur-sm transition-all duration-200 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400"
                               placeholder="e.g., Kitchen Counter, Living Room Corner" value="{{ form.location.value|default:'' }}" required>
                        <div class="absolute inset-y-0 right-0 flex items-center pr-4">
                            <i class="fas fa-location-dot text-gray-400"></i>
                        </div>
                    </div>
                    {% if form.location.errors %}
                        {% for error in form.location.errors %}
                        <p class="error-message text-red-500 text-sm mt-2 flex items-center bg-red-50 dark:bg-red-900/20 p-2 rounded-lg">
                            <i class="fas fa-exclamation-circle mr-2"></i>{{ error }}
                        </p>
                        {% endfor %}
                    {% endif %}
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="form-group">
                        <label for="{{ form.room.id_for_label }}" class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-3">
                            <div class="flex items-center space-x-2">
                                <i class="fas fa-home text-purple-500"></i>
                                <span>Room</span>
                            </div>
                        </label>
                        <div class="relative">
                            <select id="{{ form.room.id_for_label }}" name="{{ form.room.name }}"
                                    class="form-input w-full px-4 py-4 bg-white/70 dark:bg-black/30 border-2 border-gray-200/50 dark:border-gray-600/50 rounded-xl focus:outline-none focus:ring-4 focus:ring-purple-500/20 focus:border-purple-500 dark:focus:border-purple-400 backdrop-blur-sm transition-all duration-200 text-gray-900 dark:text-white appearance-none cursor-pointer">
                                <option value="">Select a room</option>
                                {% for room in form.room.field.queryset %}
                                <option value="{{ room.id }}" {% if form.room.value == room.id|stringformat:"s" %}selected{% endif %}>{{ room.name }}</option>
                                {% endfor %}
                            </select>
                            <div class="absolute inset-y-0 right-0 flex items-center pr-4 pointer-events-none">
                                <i class="fas fa-chevron-down text-gray-400"></i>
                            </div>
                        </div>
                        {% if form.room.errors %}
                            {% for error in form.room.errors %}
                            <p class="error-message text-red-500 text-sm mt-2 flex items-center bg-red-50 dark:bg-red-900/20 p-2 rounded-lg">
                                <i class="fas fa-exclamation-circle mr-2"></i>{{ error }}
                            </p>
                            {% endfor %}
                        {% endif %}
                    </div>

                    <div class="form-group">
                        <label for="{{ form.user.id_for_label }}" class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-3">
                            <div class="flex items-center space-x-2">
                                <i class="fas fa-user text-orange-500"></i>
                                <span>Assign to User</span>
                            </div>
                        </label>
                        <div class="relative">
                            <select id="{{ form.user.id_for_label }}" name="{{ form.user.name }}"
                                    class="form-input w-full px-4 py-4 bg-white/70 dark:bg-black/30 border-2 border-gray-200/50 dark:border-gray-600/50 rounded-xl focus:outline-none focus:ring-4 focus:ring-orange-500/20 focus:border-orange-500 dark:focus:border-orange-400 backdrop-blur-sm transition-all duration-200 text-gray-900 dark:text-white appearance-none cursor-pointer">
                                <option value="">Select a user</option>
                                {% for user in form.user.field.queryset %}
                                <option value="{{ user.id }}" {% if form.user.value == user.id|stringformat:"s" %}selected{% endif %}>{{ user.username }}</option>
                                {% endfor %}
                            </select>
                            <div class="absolute inset-y-0 right-0 flex items-center pr-4 pointer-events-none">
                                <i class="fas fa-chevron-down text-gray-400"></i>
                            </div>
                        </div>
                        {% if form.user.errors %}
                            {% for error in form.user.errors %}
                            <p class="error-message text-red-500 text-sm mt-2 flex items-center bg-red-50 dark:bg-red-900/20 p-2 rounded-lg">
                                <i class="fas fa-exclamation-circle mr-2"></i>{{ error }}
                            </p>
                            {% endfor %}
                        {% endif %}
                    </div>
                </div>

                <div class="form-group">
                    <label for="{{ form.device_type.id_for_label }}" class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-3">
                        <div class="flex items-center space-x-2">
                            <i class="fas fa-cube text-indigo-500"></i>
                            <span>Device Type</span>
                            <span class="text-red-500">*</span>
                        </div>
                    </label>
                    <div class="relative">
                        <select id="{{ form.device_type.id_for_label }}" name="{{ form.device_type.name }}"
                                class="form-input w-full px-4 py-4 bg-white/70 dark:bg-black/30 border-2 border-gray-200/50 dark:border-gray-600/50 rounded-xl focus:outline-none focus:ring-4 focus:ring-indigo-500/20 focus:border-indigo-500 dark:focus:border-indigo-400 backdrop-blur-sm transition-all duration-200 text-gray-900 dark:text-white appearance-none cursor-pointer" required>
                            <option value="">Select a device type</option>
                            {% for value, label in form.device_type.field.choices %}
                                <option value="{{ value }}" {% if form.device_type.value == value|stringformat:"s" %}selected{% endif %}>{{ label }}</option>
                            {% endfor %}
                        </select>
                        <div class="absolute inset-y-0 right-0 flex items-center pr-4 pointer-events-none">
                            <i class="fas fa-chevron-down text-gray-400"></i>
                        </div>
                    </div>
                    {% if form.device_type.errors %}
                        {% for error in form.device_type.errors %}
                        <p class="error-message text-red-500 text-sm mt-2 flex items-center bg-red-50 dark:bg-red-900/20 p-2 rounded-lg">
                            <i class="fas fa-exclamation-circle mr-2"></i>{{ error }}
                        </p>
                        {% endfor %}
                    {% endif %}
                </div>

                <div class="flex flex-col sm:flex-row gap-4 pt-6 border-t border-gray-200/50 dark:border-gray-700/50">
                    <button type="button" id="cancelBtn" class="flex-1 px-6 py-4 bg-gray-100 hover:bg-gray-200 dark:bg-gray-800 dark:hover:bg-gray-700 text-gray-800 dark:text-gray-200 font-semibold rounded-xl transition-all duration-200 flex items-center justify-center space-x-2">
                        <i class="fas fa-times"></i>
                        <span>Cancel</span>
                    </button>
                    <button type="submit" class="flex-1 px-6 py-4 bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-700 hover:to-purple-700 text-white font-semibold rounded-xl transition-all duration-200 flex items-center justify-center space-x-2 hover:shadow-lg transform hover:scale-[1.02]">
                        <i class="fas fa-plus"></i>
                        <span>Add Device</span>
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="w-full">
    <div class="glass rounded-xl border border-white/20 dark:border-gray-700/50 overflow-hidden">
        <div class="p-6">
           
            {% if appliances %}
                <div class="devices-grid grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="gridView">
                    {% for device in appliances %}
                    <div class="device-card bg-gradient-to-br from-blue-600 to-purple-700 dark:from-gray-800 dark:to-gray-900 text-white rounded-2xl shadow-xl overflow-hidden transform hover:scale-[1.02] transition-all duration-300" data-device-id="{{ device.id }}">
                        <div class="p-6 flex justify-between items-start">
                            <div class="flex items-center space-x-4">
                                <div class="icon-bg w-14 h-14 bg-white/20 rounded-full flex items-center justify-center text-2xl">
                                    {# Dynamic icon based on device type. Add more mappings as needed #}
                                    {% if device.device_type == 'light' %}
                                        <i class="fas fa-lightbulb"></i>
                                    {% elif device.device_type == 'fan' %}
                                        <i class="fas fa-fan"></i>
                                    {% elif device.device_type == 'tv' %}
                                        <i class="fas fa-tv"></i>
                                    {% elif device.device_type == 'speaker' %}
                                        <i class="fas fa-volume-up"></i>
                                    {% elif device.device_type == 'camera' %}
                                        <i class="fas fa-video"></i>
                                    {% else %}
                                        <i class="fas fa-plug"></i> {# Default icon #}
                                    {% endif %}
                                </div>
                                <div class="flex-1">
                                    <h4 class="font-bold text-xl">{{ device.name }}</h4>
                                    <p class="text-sm text-white/80 flex items-center mt-1">
                                        <i class="fas fa-map-marker-alt mr-1.5"></i>
                                        {{ device.location }} in {{ device.room.name|default:"N/A" }}
                                    </p>
                                </div>
                            </div>

                            <button class="status-toggle relative w-16 h-8 rounded-full bg-white/30 p-1 flex items-center transition-all duration-300 focus:outline-none"
                                    data-device-id="{{ device.id }}"
                                    data-room-id="{{ device.room.id|default:'' }}"
                                    data-status="{{ device.status|yesno:'on,off' }}"
                                    type="button">
                                <span class="absolute left-1 top-1 w-6 h-6 rounded-full shadow-md transform transition-transform duration-300
                                    {% if device.status %}translate-x-8 bg-green-400{% else %}bg-gray-300{% endif %}"></span>
                                <span class="absolute text-xs font-semibold text-white left-2 {% if device.status %}hidden{% else %}block{% endif %}">OFF</span>
                                <span class="absolute text-xs font-semibold text-white right-2 {% if device.status %}block{% else %}hidden{% endif %}">ON</span>
                            </button>
                        </div>

                        <div class="px-6 pb-6">
                            <div class="grid grid-cols-2 gap-3 text-sm text-white/80 mb-4">
                                <div class="bg-white/10 p-3 rounded-lg">
                                    <p class="uppercase tracking-wide font-medium">Status</p>
                                    <p class="font-semibold text-base mt-1">
                                        <span class="status-badge inline-flex items-center {% if device.status %}text-green-300{% else %}text-gray-300{% endif %}">
                                            <i class="fas {% if device.status %}fa-power-off{% else %}fa-circle{% endif %} mr-1.5"></i>
                                            {{ device.status|yesno:'ONLINE,OFFLINE' }}
                                        </span>
                                    </p>
                                </div>
                                <div class="bg-white/10 p-3 rounded-lg">
                                    <p class="uppercase tracking-wide font-medium">User</p>
                                    <p class="font-semibold text-base mt-1">{{ device.user.username|default:"N/A" }}</p>
                                </div>
                            </div>

                            <div class="flex gap-2 pt-2 border-t border-white/10">
                                <a href="{% if user.is_superuser %}{% url 'appliance_edit' device.id %}{% else %}#{% endif %}"
                                   class="flex-1 text-center py-2 px-3 text-sm font-medium rounded-lg transition-all duration-200 flex items-center justify-center space-x-1
                                   {% if user.is_superuser %}
                                       bg-white/10 hover:bg-white/20 text-white
                                   {% else %}
                                       bg-gray-700/50 text-gray-400 cursor-not-allowed opacity-70
                                   {% endif %}"
                                   {% if not user.is_superuser %}onclick="return false;" aria-disabled="true"{% endif %}>
                                    <i class="fas fa-edit"></i>
                                    <span>Edit</span>
                                </a>
                                <a href="{% if user.is_superuser %}{% url 'appliance_delete' device.id %}{% else %}#{% endif %}"
                                   class="flex-1 text-center py-2 px-3 text-sm font-medium rounded-lg transition-all duration-200 flex items-center justify-center space-x-1
                                   {% if user.is_superuser %}
                                       bg-red-500/30 hover:bg-red-500/50 text-red-100
                                   {% else %}
                                       bg-gray-700/50 text-gray-400 cursor-not-allowed opacity-70
                                   {% endif %}"
                                   {% if not user.is_superuser %}onclick="return false;" aria-disabled="true"{% endif %}>
                                    <i class="fas fa-trash"></i>
                                    <span>Delete</span>
                                </a>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>

                <div id="tableView" class="hidden mt-8">
                    <div class="overflow-x-auto bg-white/5 dark:bg-black/10 rounded-2xl shadow-xl border border-white/10 dark:border-gray-700/50">
                        <table class="w-full text-sm text-left text-gray-900 dark:text-white">
                            <thead class="text-xs text-gray-500 dark:text-gray-400 uppercase bg-white/10 dark:bg-black/20">
                                <tr>
                                    <th scope="col" class="px-6 py-4 font-semibold rounded-tl-2xl">Device</th>
                                    <th scope="col" class="px-6 py-4 font-semibold">Status</th>
                                    <th scope="col" class="px-6 py-4 font-semibold">Room</th>
                                    <th scope="col" class="px-6 py-4 font-semibold">Location</th>
                                    <th scope="col" class="px-6 py-4 font-semibold">Type</th>
                                    <th scope="col" class="px-6 py-4 font-semibold">User</th>
                                    <th scope="col" class="px-6 py-4 font-semibold rounded-tr-2xl">Actions</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-white/10 dark:divide-gray-700/50">
                                {% for device in appliances %}
                                <tr class="hover:bg-white/5 dark:hover:bg-black/10 transition-colors" data-device-id="{{ device.id }}">
                                    <td class="px-6 py-4 font-semibold text-gray-900 dark:text-white flex items-center">
                                        <div class="w-8 h-8 mr-3 rounded-full flex items-center justify-center text-lg
                                            {% if device.status %}
                                                bg-blue-500 text-white
                                            {% else %}
                                                bg-gray-400 text-white
                                            {% endif %}">
                                            {# Dynamic icon based on device type for table #}
                                            {% if device.device_type == 'light' %}
                                                <i class="fas fa-lightbulb"></i>
                                            {% elif device.device_type == 'fan' %}
                                                <i class="fas fa-fan"></i>
                                            {% elif device.device_type == 'tv' %}
                                                <i class="fas fa-tv"></i>
                                            {% elif device.device_type == 'speaker' %}
                                                <i class="fas fa-volume-up"></i>
                                            {% elif device.device_type == 'camera' %}
                                                <i class="fas fa-video"></i>
                                            {% else %}
                                                <i class="fas fa-plug"></i>
                                            {% endif %}
                                        </div>
                                        {{ device.name }}
                                    </td>
                                    <td class="px-6 py-4">
                                        <button class="status-toggle relative w-16 h-8 rounded-full bg-gray-200 dark:bg-gray-700 p-1 flex items-center transition-all duration-300 focus:outline-none"
                                                data-device-id="{{ device.id }}"
                                                data-room-id="{{ device.room.id|default:'' }}"
                                                data-status="{{ device.status|yesno:'on,off' }}"
                                                type="button">
                                            <span class="absolute left-1 top-1 w-6 h-6 rounded-full shadow-md transform transition-transform duration-300
                                                {% if device.status %}translate-x-8 bg-green-400{% else %}bg-gray-300 dark:bg-gray-500{% endif %}"></span>
                                            <span class="absolute text-xs font-semibold text-gray-700 dark:text-white left-2 {% if device.status %}hidden{% else %}block{% endif %}">OFF</span>
                                            <span class="absolute text-xs font-semibold text-white right-2 {% if device.status %}block{% else %}hidden{% endif %}">ON</span>
                                        </button>
                                    </td>
                                    <td class="px-6 py-4 text-gray-700 dark:text-gray-300">{{ device.room.name|default:"N/A" }}</td>
                                    <td class="px-6 py-4 text-gray-700 dark:text-gray-300">{{ device.location }}</td>
                                    <td class="px-6 py-4 text-gray-700 dark:text-gray-300">{{ device.device_type|title }}</td>
                                    <td class="px-6 py-4 text-gray-700 dark:text-gray-300">{{ device.user.username|default:"N/A" }}</td>
                                    <td class="px-6 py-4">
                                        <div class="flex items-center space-x-3">
                                            <a href="{% if user.is_superuser %}{% url 'appliance_edit' device.id %}{% else %}#{% endif %}"
                                               class="font-medium
                                               {% if user.is_superuser %}
                                                   text-primary-600 dark:text-primary-400 hover:underline
                                               {% else %}
                                                   text-gray-500 dark:text-gray-600 cursor-not-allowed opacity-70
                                               {% endif %}"
                                               {% if not user.is_superuser %}onclick="return false;" aria-disabled="true"{% endif %}>
                                                Edit
                                            </a>
                                            <a href="{% if user.is_superuser %}{% url 'appliance_delete' device.id %}{% else %}#{% endif %}"
                                               class="font-medium
                                               {% if user.is_superuser %}
                                                   text-red-600 dark:text-red-400 hover:underline
                                               {% else %}
                                                   text-gray-500 dark:text-gray-600 cursor-not-allowed opacity-70
                                               {% endif %}"
                                               {% if not user.is_superuser %}onclick="return false;" aria-disabled="true"{% endif %}>
                                                Delete
                                            </a>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            {% else %}
                <div class="text-center py-20 bg-gray-100 dark:bg-gray-800 rounded-2xl shadow-lg">
                    <div class="w-32 h-32 mx-auto mb-8 bg-gradient-to-br from-indigo-400 to-purple-500 rounded-full flex items-center justify-center shadow-lg">
                        <i class="fas fa-plug text-4xl text-white"></i>
                    </div>
                    <h3 class="text-3xl font-extrabold text-gray-900 dark:text-white mb-4">No Devices Yet!</h3>
                    <p class="text-lg text-gray-700 dark:text-gray-300 mb-8 max-w-md mx-auto">It looks like your smart home is empty. Let's get it connected and make your life easier!</p>
                    <button id="emptyStateBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-4 px-8 rounded-full shadow-lg transform hover:scale-105 transition-all duration-300 inline-flex items-center space-x-3">
                        <i class="fas fa-plus-circle text-xl"></i>
                        <span>Add Your First Device</span>
                    </button>
                </div>
            {% endif %}
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const SELECTORS = {
            addDeviceBtn: '#addDeviceBtn',
            emptyStateBtn: '#emptyStateBtn',
            addDeviceModal: '#addDeviceModal',
            modalBackdrop: '#modalBackdrop',
            closeModalBtn: '#closeModalBtn',
            cancelBtn: '#cancelBtn',
            deviceForm: '#deviceForm',
            gridViewBtn: '#gridViewBtn',
            tableViewBtn: '#tableViewBtn',
            gridView: '#gridView',
            tableView: '#tableView',
            deviceSearch: '#deviceSearch',
            statusToggles: '.status-toggle',
            totalCount: '#totalCount',
            activeCount: '#activeCount',
            inactiveCount: '#inactiveCount',
            activeRooms: '#activeRooms',
            deviceCard: '.device-card',
            tableRow: '#tableView tbody tr'
        };

        const elements = {};
        for (const key in SELECTORS) {
            elements[key] = document.querySelector(SELECTORS[key]);
        }

        // Helper function for class manipulation
        const toggleClass = (el, cls, force) => el && el.classList.toggle(cls, force);
        const addClass = (el, ...clss) => el && el.classList.add(...clss);
        const removeClass = (el, ...clss) => el && el.classList.remove(...clss);

        // Notification helper
        function showNotification(message, type = 'success') {
            const notificationContainer = document.getElementById('notification-container');
            if (!notificationContainer) {
                console.warn('Notification container not found. Please add <div id="notification-container"></div> to your base.html');
                return;
            }

            const notification = document.createElement('div');
            notification.className = `p-4 mb-3 rounded-lg shadow-md flex items-center space-x-3 fixed bottom-4 right-4 z-50 animate-fade-in-up transform translate-y-full transition-all duration-300`;

            if (type === 'success') {
                notification.classList.add('bg-green-500', 'text-white');
                notification.innerHTML = `<i class="fas fa-check-circle text-lg"></i><span>${message}</span>`;
            } else if (type === 'error') {
                notification.classList.add('bg-red-500', 'text-white');
                notification.innerHTML = `<i class="fas fa-exclamation-circle text-lg"></i><span>${message}</span>`;
            } else if (type === 'info') {
                notification.classList.add('bg-blue-500', 'text-white');
                notification.innerHTML = `<i class="fas fa-info-circle text-lg"></i><span>${message}</span>`;
            }

            notificationContainer.appendChild(notification);

            // Animate in
            setTimeout(() => {
                notification.classList.remove('translate-y-full');
                notification.classList.add('translate-y-0');
            }, 10);

            // Animate out and remove after a few seconds
            setTimeout(() => {
                notification.classList.remove('translate-y-0');
                notification.classList.add('translate-y-full');
                notification.addEventListener('transitionend', () => notification.remove(), {once: true});
            }, 5000);
        }

        // Modal functions
        const openModal = () => {
            removeClass(elements.modalBackdrop, 'invisible', 'opacity-0');
            addClass(elements.modalBackdrop, 'visible', 'opacity-100');
            removeClass(elements.addDeviceModal, 'invisible', 'opacity-0', 'scale-95');
            addClass(elements.addDeviceModal, 'visible', 'opacity-100', 'scale-100');
            document.body.classList.add('overflow-hidden');
            setTimeout(() => elements.addDeviceModal.querySelector('input[type="text"], select, textarea')?.focus(), 300);
        };

        const clearFormErrors = () => {
            document.querySelectorAll('.error-message').forEach(el => el.remove());
            document.querySelectorAll('.form-input.border-red-500').forEach(el => removeClass(el, 'border-red-500'));
        };

        const closeModal = () => {
            removeClass(elements.modalBackdrop, 'visible', 'opacity-100');
            addClass(elements.modalBackdrop, 'invisible', 'opacity-0');
            removeClass(elements.addDeviceModal, 'visible', 'opacity-100', 'scale-100');
            addClass(elements.addDeviceModal, 'invisible', 'opacity-0', 'scale-95');
            document.body.classList.remove('overflow-hidden');
            if (elements.deviceForm) {
                elements.deviceForm.reset();
                clearFormErrors();
            }
        };

        const showFormErrors = (errors) => {
            clearFormErrors();
            // Non-field errors
            if (errors.non_field_errors) {
                let nonFieldErrorsContainer = elements.deviceForm.querySelector('.non-field-errors-container');
                if (!nonFieldErrorsContainer) {
                    nonFieldErrorsContainer = document.createElement('div');
                    nonFieldErrorsContainer.className = 'non-field-errors-container error-message text-red-500 p-4 mb-4 rounded-lg bg-red-50 dark:bg-red-900/20';
                    elements.deviceForm.prepend(nonFieldErrorsContainer);
                }
                nonFieldErrorsContainer.innerHTML = ''; // Clear previous non-field errors
                errors.non_field_errors.forEach(errorText => {
                    const errorP = document.createElement('p');
                    errorP.innerHTML = `<i class="fas fa-exclamation-circle mr-2"></i>${errorText}`;
                    nonFieldErrorsContainer.appendChild(errorP);
                });
                removeClass(nonFieldErrorsContainer, 'hidden');
            }

            // Field-specific errors
            for (const fieldName in errors) {
                if (fieldName !== 'non_field_errors') {
                    const errorDetails = errors[fieldName];
                    const inputElement = document.getElementById(errorDetails.id);
                    if (inputElement) {
                        addClass(inputElement, 'border-red-500');
                        const errorP = document.createElement('p');
                        errorP.className = 'error-message text-red-500 text-sm mt-2 flex items-center bg-red-50 dark:bg-red-900/20 p-2 rounded-lg';
                        errorP.innerHTML = `<i class="fas fa-exclamation-circle mr-2"></i>${errorDetails.message}`;
                        inputElement.parentNode.insertBefore(errorP, inputElement.nextSibling);
                    }
                }
            }
        };

        // View toggle functionality
        const setActiveViewButton = (activeBtn, inactiveBtn) => {
            if (!activeBtn || !inactiveBtn) return;
            removeClass(activeBtn, 'bg-gray-200', 'text-gray-700', 'dark:bg-gray-700', 'dark:text-gray-300', 'hover:bg-gray-300', 'dark:hover:bg-gray-600');
            addClass(activeBtn, 'bg-blue-600', 'text-white'); // Use a stronger primary color for active state
            removeClass(inactiveBtn, 'bg-blue-600', 'text-white');
            addClass(inactiveBtn, 'bg-gray-200', 'text-gray-700', 'dark:bg-gray-700', 'dark:text-gray-300', 'hover:bg-gray-300', 'dark:hover:bg-gray-600');
        };

        const showGridView = () => {
            if (elements.gridView && elements.tableView && elements.gridViewBtn && elements.tableViewBtn) {
                removeClass(elements.gridView, 'hidden');
                addClass(elements.tableView, 'hidden');
                setActiveViewButton(elements.gridViewBtn, elements.tableViewBtn);
                localStorage.setItem('deviceViewPreference', 'grid');
            }
        };

        const showTableView = () => {
            if (elements.gridView && elements.tableView && elements.gridViewBtn && elements.tableViewBtn) {
                addClass(elements.gridView, 'hidden');
                removeClass(elements.tableView, 'hidden');
                setActiveViewButton(elements.tableViewBtn, elements.gridViewBtn);
                localStorage.setItem('deviceViewPreference', 'table');
            }
        };

        // Status toggle logic
        async function updateDeviceStatus(deviceId, toggleButton) {
            const currentStatus = toggleButton.dataset.status;
            const newStatus = currentStatus === 'on' ? 'off' : 'on';
            addClass(toggleButton, 'pointer-events-none', 'opacity-50'); // Disable button during API call

            const toggleHandle = toggleButton.querySelector('span:not([class*="text-"])');
            const offText = toggleButton.querySelector('.absolute.text-xs.font-semibold.text-white.left-2');
            const onText = toggleButton.querySelector('.absolute.text-xs.font-semibold.text-white.right-2');
            
            // Optimistic UI update for counts (before API call)
            const prevActiveCount = parseInt(elements.activeCount.textContent);
            const prevInactiveCount = parseInt(elements.inactiveCount.textContent);
            const prevActiveRooms = parseInt(elements.activeRooms.textContent);
            const roomId = toggleButton.dataset.roomId;

            if (newStatus === 'on') {
                elements.activeCount.textContent = prevActiveCount + 1;
                elements.inactiveCount.textContent = Math.max(0, prevInactiveCount - 1);
                // Room becomes active if it was inactive and this is the first device activating
                if (roomId && !Array.from(document.querySelectorAll(`${SELECTORS.statusToggles}[data-room-id="${roomId}"]`)).some(t => t.dataset.status === 'on' && t.dataset.deviceId !== deviceId)) {
                     elements.activeRooms.textContent = prevActiveRooms + 1;
                }
            } else {
                elements.activeCount.textContent = Math.max(0, prevActiveCount - 1);
                elements.inactiveCount.textContent = prevInactiveCount + 1;
                // Room becomes inactive if this was the last active device
                if (roomId && !Array.from(document.querySelectorAll(`${SELECTORS.statusToggles}[data-room-id="${roomId}"]`)).some(t => t.dataset.status === 'on' && t.dataset.deviceId !== deviceId)) {
                    elements.activeRooms.textContent = Math.max(0, prevActiveRooms - 1);
                }
            }
            
            // Apply visual changes immediately
            toggleClass(toggleHandle, 'translate-x-8', newStatus === 'on');
            toggleClass(toggleHandle, 'bg-green-400', newStatus === 'on');
            toggleClass(toggleHandle, 'bg-gray-300', newStatus === 'off');
            toggleClass(toggleHandle, 'dark:bg-gray-500', newStatus === 'off');
            toggleClass(offText, 'hidden', newStatus === 'on');
            toggleClass(onText, 'hidden', newStatus === 'off');

            document.querySelectorAll(`[data-device-id="${deviceId}"]`).forEach(deviceEl => {
                const statusBadge = deviceEl.querySelector('.status-badge');
                if (statusBadge) {
                    const iconClass = newStatus === 'on' ? 'fa-power-off' : 'fa-circle';
                    const statusText = newStatus === 'on' ? 'ONLINE' : 'OFFLINE';
                    statusBadge.innerHTML = `<i class="fas ${iconClass} mr-1.5"></i><span>${statusText}</span>`;
                    toggleClass(statusBadge, 'text-green-300', newStatus === 'on');
                    toggleClass(statusBadge, 'text-gray-300', newStatus === 'off');
                }
                const tableIconDiv = deviceEl.querySelector('td .w-8.h-8.mr-3.rounded-full');
                if (tableIconDiv) {
                    toggleClass(tableIconDiv, 'bg-blue-500', newStatus === 'on');
                    toggleClass(tableIconDiv, 'bg-gray-400', newStatus === 'off');
                }
            });
            toggleButton.dataset.status = newStatus; // Update data-status AFTER UI changes

            try {
                const response = await fetch(`/control/toggle/${deviceId}/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                    },
                    body: JSON.stringify({ status: newStatus === 'on' })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Failed to toggle device status');
                }
                showNotification('Device status updated successfully', 'success');

            } catch (error) {
                console.error('Network or server error:', error);
                showNotification(`Error: ${error.message}`, 'error');
                // Revert UI on error (undo optimistic update)
                const originalStatusBool = currentStatus === 'on'; // The actual original status
                toggleButton.dataset.status = currentStatus; // Revert data-status

                toggleClass(toggleHandle, 'translate-x-8', originalStatusBool);
                toggleClass(toggleHandle, 'bg-green-400', originalStatusBool);
                toggleClass(toggleHandle, 'bg-gray-300', !originalStatusBool);
                toggleClass(toggleHandle, 'dark:bg-gray-500', !originalStatusBool);
                toggleClass(offText, 'hidden', originalStatusBool);
                toggleClass(onText, 'hidden', !originalStatusBool);
                
                // Revert counts
                elements.activeCount.textContent = prevActiveCount;
                elements.inactiveCount.textContent = prevInactiveCount;
                elements.activeRooms.textContent = prevActiveRooms; // Simplified revert, assumes rooms were correctly calculated.

                document.querySelectorAll(`[data-device-id="${deviceId}"]`).forEach(deviceEl => {
                    const statusBadge = deviceEl.querySelector('.status-badge');
                    if (statusBadge) {
                        const iconClass = originalStatusBool ? 'fa-power-off' : 'fa-circle';
                        const statusText = originalStatusBool ? 'ONLINE' : 'OFFLINE';
                        statusBadge.innerHTML = `<i class="fas ${iconClass} mr-1.5"></i><span>${statusText}</span>`;
                        toggleClass(statusBadge, 'text-green-300', originalStatusBool);
                        toggleClass(statusBadge, 'text-gray-300', !originalStatusBool);
                    }
                    const tableIconDiv = deviceEl.querySelector('td .w-8.h-8.mr-3.rounded-full');
                    if (tableIconDiv) {
                        toggleClass(tableIconDiv, 'bg-blue-500', originalStatusBool);
                        toggleClass(tableIconDiv, 'bg-gray-400', !originalStatusBool);
                    }
                });
            } finally {
                removeClass(toggleButton, 'pointer-events-none', 'opacity-50'); // Re-enable button
            }
        }


        // --- Event Listeners Initialization ---
        elements.addDeviceBtn?.addEventListener('click', openModal);
        elements.emptyStateBtn?.addEventListener('click', openModal); // For the "No devices yet!" button
        elements.closeModalBtn?.addEventListener('click', closeModal);
        elements.cancelBtn?.addEventListener('click', closeModal);
        elements.modalBackdrop?.addEventListener('click', closeModal);
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && elements.addDeviceModal?.classList.contains('visible')) { // Check actual visibility class
                closeModal();
            }
        });

        elements.gridViewBtn?.addEventListener('click', showGridView);
        elements.tableViewBtn?.addEventListener('click', showTableView);

        // Load saved view preference on page load
        const savedView = localStorage.getItem('deviceViewPreference') || 'grid';
        if (savedView === 'table') {
            showTableView();
        } else {
            showGridView();
        }

        elements.deviceSearch?.addEventListener('input', function() {
            const searchTerm = this.value.toLowerCase();
            document.querySelectorAll(SELECTORS.deviceCard).forEach(card => {
                const deviceName = card.querySelector('h4')?.textContent.toLowerCase() || '';
                const deviceLocation = card.querySelector('p.text-sm.text-white\\/80')?.textContent.toLowerCase() || '';
                card.style.display = (deviceName.includes(searchTerm) || deviceLocation.includes(searchTerm)) ? 'block' : 'none';
            });
            document.querySelectorAll(SELECTORS.tableRow).forEach(row => {
                const shouldShow = Array.from(row.querySelectorAll('td')).some(cell => cell.textContent.toLowerCase().includes(searchTerm));
                row.style.display = shouldShow ? 'table-row' : 'none';
            });
        });

        elements.deviceForm?.addEventListener('submit', async function(e) {
            e.preventDefault();
            const submitButton = this.querySelector('button[type="submit"]');
            const originalButtonContent = submitButton.innerHTML;

            clearFormErrors();

            submitButton.disabled = true;
            submitButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Adding Device...';

            try {
                const response = await fetch(this.action, {
                    method: 'POST',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                    },
                    body: new FormData(this)
                });

                const data = await response.json();

                if (response.ok) {
                    showNotification(data.message || 'Device added successfully!', 'success');
                    closeModal();
                    window.location.reload(); 
                } else {
                    showFormErrors(data.errors);
                    showNotification(data.message || 'Please correct the errors in the form.', 'error');
                }
            } catch (error) {
                console.error('Fetch error for add device form:', error);
                showNotification('An unexpected error occurred. Please try again.', 'error');
            } finally {
                submitButton.disabled = false;
                submitButton.innerHTML = originalButtonContent;
            }
        });

        document.querySelectorAll(SELECTORS.statusToggles).forEach(button => {
            button.addEventListener('click', () => updateDeviceStatus(button.dataset.deviceId, button));
        });

        // Handle URL parameters for initial notifications
        const urlParams = new URLSearchParams(window.location.search);
        const statusParam = urlParams.get('status');
        const messageParam = urlParams.get('message');
        if (statusParam && messageParam) {
            showNotification(messageParam, statusParam);
            history.replaceState({}, document.title, window.location.pathname);
        }

        // Ensure data-device-id is set on cards (for grid view search)
        document.querySelectorAll(SELECTORS.deviceCard).forEach(card => {
            const toggleBtn = card.querySelector(SELECTORS.statusToggles);
            if (toggleBtn && toggleBtn.dataset.deviceId) {
                card.dataset.deviceId = toggleBtn.dataset.deviceId;
            }
        });
    });
</script>
{% endblock %}